{"status":{},"spec":{"description":"","resources":{"client_attrs":{"36fafd37-208e-0530-18fb-f008e814a24e":{"y":-357.2714986907,"x":-254.5173274591},"475ef8f3_deployment":{"y":-1250.1968149635,"x":-1601.392990966},"84766b31-05e0-60e3-3970-8e4303e5443f":{"y":-1264.6967773438,"x":-1766.6429443359},"7fd4467f-d9ca-4518-45a3-8361e9593f2b":{"y":-146.9111006778,"x":121.7498661769}},"service_definition_list":[{"singleton":false,"action_list":[{"description":"System action for creating an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"W2k12 IIS"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"e2f5e268_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"7e63b2f6_runbook","main_task_local_reference":{"kind":"app_task","name":"e2f5e268_dag"},"variable_list":[]},"name":"action_create"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"W2k12 IIS"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"12750efa_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"9401dc4d_runbook","main_task_local_reference":{"kind":"app_task","name":"12750efa_dag"},"variable_list":[]},"name":"action_delete"},{"description":"System action for starting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"W2k12 IIS"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"f1f7c768_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"7cd1acbb_runbook","main_task_local_reference":{"kind":"app_task","name":"f1f7c768_dag"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"W2k12 IIS"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"0bbc117e_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"2512b8c1_runbook","main_task_local_reference":{"kind":"app_task","name":"0bbc117e_dag"},"variable_list":[]},"name":"action_stop"},{"description":"System action for restarting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"W2k12 IIS"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"073eb51f_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"444dc194_runbook","main_task_local_reference":{"kind":"app_task","name":"073eb51f_dag"},"variable_list":[]},"name":"action_restart"}],"depends_on_list":[],"name":"W2k12 IIS","port_list":[],"tier":"","variable_list":[],"description":""}],"substrate_definition_list":[{"description":"","action_list":[],"type":"AHV_VM","name":"IIS Application X","readiness_probe":{"connection_type":"POWERSHELL","retries":"5","disable_readiness_probe":false,"address":"@@{platform.status.resources.nic_list[0].ip_endpoint_list[0].ip}@@","delay_secs":"60","connection_port":5985,"login_credential_local_reference":{"kind":"app_credential","name":"SysprepCreds"}},"editables":{"create_spec":{"name":true,"resources":{"nic_list":{"0":{"subnet_reference":true}},"serial_port_list":{},"disk_list":{}}}},"os_type":"Windows","create_spec":{"name":"IIS-@@{calm_time}@@","resources":{"nic_list":[{"nic_type":"NORMAL_NIC","ip_endpoint_list":[],"network_function_chain_reference":null,"network_function_nic_type":"INGRESS","mac_address":"","subnet_reference":{"kind":"subnet","type":"","name":"","uuid":"6d49152e-7697-4c7a-9ae4-60def98282cb"},"type":""}],"serial_port_list":[],"guest_tools":null,"num_vcpus_per_socket":1,"num_sockets":4,"gpu_list":[],"memory_size_mib":8192,"parent_reference":null,"hardware_clock_timezone":"","guest_customization":{"cloud_init":null,"type":"","sysprep":{"install_type":"PREPARED","unattend_xml":"<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<unattend xmlns=\"urn:schemas-microsoft-com:unattend\">\n    <settings pass=\"oobeSystem\">\n        <component name=\"Microsoft-Windows-International-Core\" processorArchitecture=\"amd64\" publicKeyToken=\"31bf3856ad364e35\" language=\"neutral\" versionScope=\"nonSxS\" xmlns:wcm=\"http:\/\/schemas.microsoft.com\/WMIConfig\/2002\/State\" xmlns:xsi=\"http:\/\/www.w3.org\/2001\/XMLSchema-instance\">\n            <InputLocale>0413:00020409<\/InputLocale>\n            <SystemLocale>en-US<\/SystemLocale>\n            <UILanguageFallback>en-US<\/UILanguageFallback>\n            <UserLocale>nl-NL<\/UserLocale>\n        <\/component>\n        <component name=\"Microsoft-Windows-Shell-Setup\" processorArchitecture=\"amd64\" publicKeyToken=\"31bf3856ad364e35\" language=\"neutral\" versionScope=\"nonSxS\" xmlns:wcm=\"http:\/\/schemas.microsoft.com\/WMIConfig\/2002\/State\" xmlns:xsi=\"http:\/\/www.w3.org\/2001\/XMLSchema-instance\">\n            <AutoLogon>\n                <Enabled>true<\/Enabled>\n                <LogonCount>9999999<\/LogonCount>\n                <Username>Administrator<\/Username>\n                <Password>\n                    <PlainText>true<\/PlainText>\n                    <Value>@@{SysprepCreds.secret}@@<\/Value>\n                <\/Password>\n            <\/AutoLogon>\n            <OOBE>\n                <HideEULAPage>true<\/HideEULAPage>\n                <HideWirelessSetupInOOBE>true<\/HideWirelessSetupInOOBE>\n                <NetworkLocation>Home<\/NetworkLocation>\n                <ProtectYourPC>2<\/ProtectYourPC>\n            <\/OOBE>\n            <UserAccounts>\n                <AdministratorPassword>\n                    <PlainText>true<\/PlainText>\n                    <Value>@@{SysprepCreds.secret}@@<\/Value>\n                <\/AdministratorPassword>\n            <\/UserAccounts>\n            <FirstLogonCommands>\n                <SynchronousCommand wcm:action=\"add\">\n                    <CommandLine>cmd.exe \/c winrm quickconfig -q<\/CommandLine>\n                    <Description>Win RM quickconfig -q<\/Description>\n                    <Order>20<\/Order>\n                    <RequiresUserInput>true<\/RequiresUserInput>\n                <\/SynchronousCommand>\n                <SynchronousCommand wcm:action=\"add\">\n                    <CommandLine>cmd.exe \/c winrm quickconfig -transport:http<\/CommandLine>\n                    <Description>Win RM quickconfig -transport:http<\/Description>\n                    <Order>21<\/Order>\n                    <RequiresUserInput>true<\/RequiresUserInput>\n                <\/SynchronousCommand>\n                <SynchronousCommand wcm:action=\"add\">\n                    <CommandLine>cmd.exe \/c winrm set winrm\/config @{MaxTimeoutms=\"1800000\"}<\/CommandLine>\n                    <Description>Win RM MaxTimoutms<\/Description>\n                    <Order>22<\/Order>\n                    <RequiresUserInput>true<\/RequiresUserInput>\n                <\/SynchronousCommand>\n                <SynchronousCommand wcm:action=\"add\">\n                    <CommandLine>cmd.exe \/c winrm set winrm\/config\/winrs @{MaxMemoryPerShellMB=\"300\"}<\/CommandLine>\n                    <Description>Win RM MaxMemoryPerShellMB<\/Description>\n                    <Order>23<\/Order>\n                    <RequiresUserInput>true<\/RequiresUserInput>\n                <\/SynchronousCommand>\n                <SynchronousCommand wcm:action=\"add\">\n                    <CommandLine>cmd.exe \/c winrm set winrm\/config\/service @{AllowUnencrypted=\"true\"}<\/CommandLine>\n                    <Description>Win RM AllowUnencrypted<\/Description>\n                    <Order>24<\/Order>\n                    <RequiresUserInput>true<\/RequiresUserInput>\n                <\/SynchronousCommand>\n                <SynchronousCommand wcm:action=\"add\">\n                    <CommandLine>cmd.exe \/c winrm set winrm\/config\/service\/auth @{Basic=\"true\"}<\/CommandLine>\n                    <Description>Win RM auth Basic<\/Description>\n                    <Order>25<\/Order>\n                    <RequiresUserInput>true<\/RequiresUserInput>\n                <\/SynchronousCommand>\n                <SynchronousCommand wcm:action=\"add\">\n                    <CommandLine>cmd.exe \/c winrm set winrm\/config\/client\/auth @{Basic=\"true\"}<\/CommandLine>\n                    <Description>Win RM auth Basic<\/Description>\n                    <Order>26<\/Order>\n                    <RequiresUserInput>true<\/RequiresUserInput>\n                <\/SynchronousCommand>\n                <SynchronousCommand wcm:action=\"add\">\n                    <CommandLine>cmd.exe \/c winrm set winrm\/config\/listener?Address=*+Transport=HTTP @{Port=\"5985\"} <\/CommandLine>\n                    <Description>Win RM listener Address\/Port<\/Description>\n                    <Order>27<\/Order>\n                    <RequiresUserInput>true<\/RequiresUserInput>\n                <\/SynchronousCommand>\n                <SynchronousCommand wcm:action=\"add\">\n                    <CommandLine>cmd.exe \/c netsh advfirewall firewall set rule group=\"remote administration\" new enable=yes <\/CommandLine>\n                    <Description>Win RM adv firewall enable<\/Description>\n                    <Order>29<\/Order>\n                    <RequiresUserInput>true<\/RequiresUserInput>\n                <\/SynchronousCommand>\n                <SynchronousCommand wcm:action=\"add\">\n                    <CommandLine>cmd.exe \/c net stop winrm <\/CommandLine>\n                    <Description>Stop Win RM Service <\/Description>\n                    <Order>28<\/Order>\n                    <RequiresUserInput>true<\/RequiresUserInput>\n                <\/SynchronousCommand>\n                <SynchronousCommand wcm:action=\"add\">\n                    <CommandLine>cmd.exe \/c net start winrm <\/CommandLine>\n                    <Description>Start Win RM Service<\/Description>\n                    <Order>32<\/Order>\n                    <RequiresUserInput>true<\/RequiresUserInput>\n                <\/SynchronousCommand>\n                <SynchronousCommand wcm:action=\"add\">\n                    <CommandLine>powershell -Command &quot;Set-ExecutionPolicy -ExecutionPolicy Unrestricted -Force&quot;<\/CommandLine>\n                    <Description>Set PowerShell ExecutionPolicy<\/Description>\n                    <Order>1<\/Order>\n                    <RequiresUserInput>true<\/RequiresUserInput>\n                <\/SynchronousCommand>\n                <SynchronousCommand wcm:action=\"add\">\n                    <Order>2<\/Order>\n                    <RequiresUserInput>true<\/RequiresUserInput>\n                    <CommandLine>powershell -Command &quot;Enable-PSRemoting -Force&quot;<\/CommandLine>\n                    <Description>Enable PowerShell Remoting<\/Description>\n                <\/SynchronousCommand>\n                <SynchronousCommand wcm:action=\"add\">\n                    <Order>5<\/Order>\n                    <RequiresUserInput>true<\/RequiresUserInput>\n                    <Description>RDP adv firewall enable<\/Description>\n                    <CommandLine>cmd.exe \/c netsh advfirewall firewall set rule group=&quot;Remote Desktop&quot; new enable=yes <\/CommandLine>\n                <\/SynchronousCommand>\n                <SynchronousCommand wcm:action=\"add\">\n                    <Order>31<\/Order>\n                    <CommandLine>cmd.exe \/c sc config winrm start= auto<\/CommandLine>\n                    <RequiresUserInput>true<\/RequiresUserInput>\n                    <Description>No-Delay Auto start WinRM on boot<\/Description>\n                <\/SynchronousCommand>\n                <SynchronousCommand wcm:action=\"add\">\n                    <Order>30<\/Order>\n                    <RequiresUserInput>true<\/RequiresUserInput>\n                    <CommandLine>cmd.exe \/c netsh advfirewall set allprofiles state off<\/CommandLine>\n                    <Description>Disable Windows Firewall<\/Description>\n                <\/SynchronousCommand>\n            <\/FirstLogonCommands>\n<ShowWindowsLive>false<\/ShowWindowsLive>\n        <\/component>\n    <\/settings>\n    <settings pass=\"specialize\">\n        <component name=\"Microsoft-Windows-Deployment\" processorArchitecture=\"amd64\" publicKeyToken=\"31bf3856ad364e35\" language=\"neutral\" versionScope=\"nonSxS\" xmlns:wcm=\"http:\/\/schemas.microsoft.com\/WMIConfig\/2002\/State\" xmlns:xsi=\"http:\/\/www.w3.org\/2001\/XMLSchema-instance\">\n            <RunSynchronous>\n                <RunSynchronousCommand wcm:action=\"add\">\n                    <Order>1<\/Order>\n                    <Path>net user administrator \/active:Yes<\/Path>\n                    <WillReboot>Never<\/WillReboot>\n                <\/RunSynchronousCommand>\n            <\/RunSynchronous>\n        <\/component>\n        <component name=\"Microsoft-Windows-Security-SPP-UX\" processorArchitecture=\"amd64\" publicKeyToken=\"31bf3856ad364e35\" language=\"neutral\" versionScope=\"nonSxS\" xmlns:wcm=\"http:\/\/schemas.microsoft.com\/WMIConfig\/2002\/State\" xmlns:xsi=\"http:\/\/www.w3.org\/2001\/XMLSchema-instance\">\n            <SkipAutoActivation>true<\/SkipAutoActivation>\n        <\/component>\n        <component name=\"Microsoft-Windows-Shell-Setup\" processorArchitecture=\"amd64\" publicKeyToken=\"31bf3856ad364e35\" language=\"neutral\" versionScope=\"nonSxS\" xmlns:wcm=\"http:\/\/schemas.microsoft.com\/WMIConfig\/2002\/State\" xmlns:xsi=\"http:\/\/www.w3.org\/2001\/XMLSchema-instance\">\n            <ComputerName>*<\/ComputerName>\n        <\/component>\n    <\/settings>\n    <settings pass=\"windowsPE\">\n        <component name=\"Microsoft-Windows-International-Core-WinPE\" processorArchitecture=\"amd64\" publicKeyToken=\"31bf3856ad364e35\" language=\"neutral\" versionScope=\"nonSxS\" xmlns:wcm=\"http:\/\/schemas.microsoft.com\/WMIConfig\/2002\/State\" xmlns:xsi=\"http:\/\/www.w3.org\/2001\/XMLSchema-instance\">\n            <SetupUILanguage>\n            <UILanguage>en-US <\/UILanguage>\n            <\/SetupUILanguage>\n            <InputLocale>en-US <\/InputLocale>\n            <SystemLocale>en-US <\/SystemLocale>\n            <UILanguage>en-US <\/UILanguage>\n            <UILanguageFallback>en-US <\/UILanguageFallback>\n            <UserLocale>en-US <\/UserLocale>\n        <\/component>\n    <\/settings>\n<\/unattend>","type":""}},"power_state":"ON","type":"","boot_config":{"boot_device":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"}},"type":"","mac_address":""},"disk_list":[{"data_source_reference":{"kind":"image","type":"","name":"Windows 2012","uuid":"794b520b-908f-45ee-8650-d51316406a3b"},"type":"","disk_size_mib":0,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"},"device_type":"DISK"}}]},"availability_zone_reference":null,"backup_policy":null,"type":"","cluster_reference":null,"categories":{"Environment":"Production","AppFamily":"DevOps"}},"variable_list":[]}],"credential_definition_list":[{"username":"administrator","description":"","type":"PASSWORD","secret":{"attrs":{"is_secret_modified":false,"secret_reference":{}}},"name":"SysprepCreds","editables":{"secret":true}},{"username":"administrator","description":"","type":"PASSWORD","secret":{"attrs":{"is_secret_modified":false,"secret_reference":{}}},"name":"DomainCreds","editables":{"secret":true}}],"package_definition_list":[{"description":"","action_list":[],"type":"DEB","service_local_reference_list":[{"kind":"app_service","name":"W2k12 IIS"}],"name":"Install and Configure IIS","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Install and Configure IIS"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[{"kind":"app_task","name":"Rename and Join Domain"},{"kind":"app_task","name":"Wait for Reboot"},{"kind":"app_task","name":"Install IIS"},{"kind":"app_task","name":"Create Website"},{"kind":"app_task","name":"Inject Config"},{"kind":"app_task","name":"Set Fixed IP"},{"kind":"app_task","name":"Wait for Fixed IP"},{"kind":"app_task","name":"Install Add NLB Cluster"}],"name":"5baea253_dag","state":"ACTIVE","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Create Website"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Inject Config"}},{"from_task_reference":{"kind":"app_task","name":"Inject Config"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Set Fixed IP"}},{"from_task_reference":{"kind":"app_task","name":"Rename and Join Domain"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Wait for Reboot"}},{"from_task_reference":{"kind":"app_task","name":"Wait for Reboot"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Install IIS"}},{"from_task_reference":{"kind":"app_task","name":"Wait for Fixed IP"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Install Add NLB Cluster"}},{"from_task_reference":{"kind":"app_task","name":"Install IIS"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Create Website"}},{"from_task_reference":{"kind":"app_task","name":"Set Fixed IP"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Wait for Fixed IP"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"W2k12 IIS"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"Rename and Join Domain","state":"ACTIVE","attrs":{"exit_status":[],"script":"\nwrite-host \"Starting\"\n$DomainUsername = \"@@{DomainCreds.username}@@\";\n$DomainPassword = \"@@{DomainCreds.secret}@@\";\n$MachineName = \"@@{MachineName}@@\";\n$domainname = \"@@{DomainFQDN}@@\";\n\nwrite-host \"Using $DomainUsername user\"\nwrite-host \"using $MachineName machine name\"\n\n$Securepass = ConvertTo-SecureString -asPlainText -Force -String $DomainPassword;\n$credential = New-Object System.Management.Automation.PSCredential(\"$($DomainName)\\$($DomainUsername)\",$Securepass);\n\ntry {;\n  Rename-Computer -NewName $MachineName -force -confirm:0;\n  $restart = 1;\n} catch {;\n  write-host \"Rename computer failed.\";\n};\ntry {;\n  write-host \"Joining machine to $domainname using \";\n  Add-computer -DomainName $DomainName -Credential $credential -force -Options JoinWithNewName,AccountCreate;\n  $restart = 1;\n} catch {\n  if ((Get-WmiObject -Class Win32_ComputerSystem).PartOfDomain){;\n    write-host \"Machine is already part of the domain.\";\n  } else {;\n    write-host \"Error joining machine to the domain. Machine is not joined.\";\n  };\n};\nif ($restart -eq 1){;\n  shutdown -r -t 20 -f;\n};\n\n","script_type":"npsscript","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"SysprepCreds"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"W2k12 IIS"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"Wait for Reboot","state":"ACTIVE","attrs":{"type":"","interval_secs":60},"timeout_secs":"0","type":"DELAY","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"W2k12 IIS"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"Install IIS","state":"ACTIVE","attrs":{"exit_status":[],"script":"Enable-WindowsOptionalFeature -Online -FeatureName IIS-WebServerRole\nEnable-WindowsOptionalFeature -Online -FeatureName IIS-WebServer\nEnable-WindowsOptionalFeature -Online -FeatureName IIS-CommonHttpFeatures\nEnable-WindowsOptionalFeature -Online -FeatureName IIS-HttpErrors\nEnable-WindowsOptionalFeature -Online -FeatureName IIS-HttpRedirect\nEnable-WindowsOptionalFeature -Online -FeatureName IIS-Security\nEnable-WindowsOptionalFeature -Online -FeatureName IIS-RequestFiltering\nEnable-WindowsOptionalFeature -Online -FeatureName IIS-Performance\nEnable-WindowsOptionalFeature -Online -FeatureName IIS-WebServerManagementTools\nEnable-WindowsOptionalFeature -Online -FeatureName IIS-IIS6ManagementCompatibility\nEnable-WindowsOptionalFeature -Online -FeatureName IIS-Metabase\nEnable-WindowsOptionalFeature -Online -FeatureName IIS-ManagementConsole\nAdd-WindowsFeature NLB\nadd-WindowsFeature RSAT-NLB","script_type":"npsscript","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"DomainCreds"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"W2k12 IIS"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"Create Website","state":"ACTIVE","attrs":{"exit_status":[],"script":"$appname = \"@@{IISAppName}@@\"\n$fqdn = \"@@{IISwwwFQDN}@@\"\nImport-Module WebAdministration\n\ncd iis:\\apppools\nNew-WebAppPool -name \"$($appname)-AppPool\" -force\n$appPool = Get-Item \"$($appname)-AppPool\" \n$appPool.processModel.identityType = \"NetworkService\"\n$appPool.enable32BitAppOnWin64 = 1\n$appPool | Set-Item\nmd \"c:\\Web Sites\\$($appname)\"\n\n$site = new-WebSite -name \"$($appname)\" -PhysicalPath \"c:\\Web Sites\\$($appname)\" -HostHeader \"$($fqdn)\" -ApplicationPool \"$($appname)-AppPool\" -force","script_type":"npsscript","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"DomainCreds"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"W2k12 IIS"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"Inject Config","state":"ACTIVE","attrs":{"exit_status":[],"script":"$file = \"C:\\inetpub\\wwwroot\\iisstart.html\"\nwrite '<head>' | out-file $file\nwrite '<meta http-equiv=\"Content-Type\" content=\"text\/html; charset=iso-8859-1\" \/>' | out-file $file -append\nwrite '<title>Propellor<\/title>' | out-file $file\nwrite '<style type=\"text\/css\">' | out-file $file\nwrite '<!--' | out-file $file\nwrite 'body {' | out-file $file\nwrite '  color:#000000;' | out-file $file\nwrite '  background-color:#000000;' | out-file $file\nwrite '  margin:0;' | out-file $file\nwrite '}' | out-file $file\nwrite '#container {' | out-file $file\nwrite '  margin-left:auto;' | out-file $file\nwrite '  margin-right:auto;' | out-file $file\nwrite '  text-align:center;' | out-file $file\nwrite '  }' | out-file $file\nwrite 'a img {' | out-file $file\nwrite '  border:none;' | out-file $file\nwrite '}' | out-file $file\nwrite '-->' | out-file $file\nwrite '<\/style>' | out-file $file\nwrite '<\/head>' | out-file $file\nwrite '<body>' | out-file $file\nwrite '<div id=\"container\">' | out-file $file\nwrite '<a href=\"https:\/\/www.propellor.eu\/\"><img src=\"https:\/\/mail.mmouse.nl\/wwwdump\/propellor.png\" alt=\"IIS\" width=\"960\" height=\"600\" \/><\/a>' | out-file $file -append\nwrite '<\/div>' | out-file $file\nwrite '<\/body>' | out-file $file\nwrite '<\/html>' | out-file $file","script_type":"npsscript","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"DomainCreds"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"W2k12 IIS"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"Set Fixed IP","state":"ACTIVE","attrs":{"exit_status":[],"script":"$DomainUsername = \"@@{DomainCreds.username}@@\";\n$DomainPassword = \"@@{DomainCreds.secret}@@\"; \n$domainname = \"@@{DomainFQDN}@@\";\n$Securepass = ConvertTo-SecureString -asPlainText -Force -String $DomainPassword;\n$credential = New-Object System.Management.Automation.PSCredential(\"$($DomainName)\\$($DomainUsername)\",$Securepass);\n$domainuser = \"$($DomainName)\\$($DomainUsername)\"\n$file = \"C:\\windows\\temp\\ChangeIP.ps1\"\nwrite '$interface = get-netadapter' | out-file $file\nwrite '$nlbnamepart2 = \"@@{DomainFQDN}@@\"' | out-file $file -append\nwrite '$nlbnamepart1 = \"@@{IISAppName}@@\"' | out-file $file -append\nwrite '$MachineName = \"@@{MachineName}@@\";' | out-file $file -append\nwrite '$domainname = \"@@{DomainFQDN}@@\";' | out-file $file -append\nwrite '$nlbname = \"$($nlbnamepart1).$($nlbnamepart2)\"' | out-file $file -append\nwrite '$IP = get-NetIPAddress | where {$_.InterfaceAlias -eq $interface.name -and $_.AddressFamily -eq \"IPv4\"}' | out-file $file -append\nwrite '$detail = Get-NetIPConfiguration' | out-file $file -append\nwrite '$nic_configuration = gwmi -class \"win32_networkadapterconfiguration\" | Where-Object {$_.defaultIPGateway -ne $null}' | out-file $file -append\nwrite '$prefix = $IP.prefixlength' | out-file $file -append\nwrite '$nodename = Get-WMIObject Win32_ComputerSystem | Select-Object -ExpandProperty name;' | out-file $file -append\nwrite '$gateway = $detail.IPv4DefaultGateway.nexthop;' | out-file $file -append\nwrite '$Ip = $detail.IPv4Address.ipaddress;' | out-file $file -append\nwrite '$index = (Get-NetAdapter).InterfaceIndex' | out-file $file -append\nwrite '$dns1 = (($detail.dnsserver | where {$_.interfaceindex -eq $index}).serveraddresses)[0]' | out-file $file -append\nwrite '$dns2 = (($detail.dnsserver | where {$_.interfaceindex -eq $index}).serveraddresses)[1]' | out-file $file -append\nwrite 'write-host \"Using $DomainUsername user\"' | out-file $file -append\nwrite 'write-host \"using $MachineName machine name\"' | out-file $file -append\nwrite '$hide = Set-Item WSMan:\\localhost\\Client\\TrustedHosts -Value \"*\" -confirm:0 -force -ea:0' | out-file $file -append\nwrite 'if ($ip.PrefixOrigin -eq \"Manual\"){ ' | out-file $file -append\nwrite '  write-host \"All Done\"' | out-file $file -append\nwrite '} else {' | out-file $file -append\nwrite '  Sleep 60' | out-file $file -append\nwrite '  write-host \"Changing IP to static\"' | out-file $file -append\nwrite '  write-host \"Changing IP to $Ip\"' | out-file $file -append\nwrite '  write-host \"Using $gateway as gateway\"' | out-file $file -append\nwrite '  write-host \"Using $prefix as prefix\"' | out-file $file -append\nwrite '  write-host \"Using $index as index\"' | out-file $file -append\nwrite '  ipconfig \/release' | out-file $file -append\nwrite '  sleep 5' | out-file $file -append\nwrite '  New-NetIPAddress -IPAddress $IP -DefaultGateway $gateway -PrefixLength $prefix -InterfaceIndex $index -ea:0' | out-file $file -append\nwrite '  Set-DnsClientServerAddress -InterfaceIndex $index -ServerAddresses ($dns1, $dns2)' | out-file $file -append\nwrite '}' | out-file $file -append\n\n\n$jobname = \"PowerShell Task\";\n$script = \"C:\\windows\\temp\\ChangeIP.ps1\";\n$action = New-ScheduledTaskAction \u2013Execute \"$pshome\\powershell.exe\" -Argument  \"$script > c:\\windows\\temp\\changeip.log\";\n$duration = ([timeSpan]::maxvalue);\n$repeat = (New-TimeSpan -hours 3);\n$trigger =New-ScheduledTaskTrigger -Once -At (Get-Date).Date -RepetitionInterval $repeat -RepetitionDuration $duration;\n$settings = New-ScheduledTaskSettingsSet -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries -StartWhenAvailable -RunOnlyIfNetworkAvailable -DontStopOnIdleEnd;\n$task = Register-ScheduledTask -TaskName $jobname -Action $action -Trigger $trigger -RunLevel Highest -User $domainuser -Password $DomainPassword -Settings $settings;\nGet-ScheduledTask \"*Powershell*\" | start-scheduledtask","script_type":"npsscript","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"DomainCreds"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"W2k12 IIS"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"Wait for Fixed IP","state":"ACTIVE","attrs":{"type":"","interval_secs":120},"timeout_secs":"0","type":"DELAY","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"W2k12 IIS"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"Install Add NLB Cluster","state":"ACTIVE","attrs":{"exit_status":[],"script":"$interface = get-netadapter\n$nlbname = \"@@{IISAppName}@@.@@{DomainFQDN}@@\"\n$CLIP = \"@@{NLBIP}@@\"\n$IP = get-NetIPAddress | where {$_.InterfaceAlias -eq $interface.name -and $_.AddressFamily -eq \"IPv4\"}\n$detail = Get-NetIPConfiguration\n$nic_configuration = gwmi -computer .  -class \"win32_networkadapterconfiguration\" | Where-Object {$_.defaultIPGateway -ne $null}\n$subnet = $nic_configuration.ipsubnet | where {$_ -match \"\\.\"}\n$prefix = $IP.prefixlength\n$nodename = Get-WMIObject Win32_ComputerSystem | Select-Object -ExpandProperty name;\ntry {;\n  $cluster = Get-NlbCluster $CLIP;\n} catch {;\n  write-host \"NLB does not exist yet, creating.\";\n};\nif ($cluster){;\n  $cluster | Add-NlbClusterNode -NewNodeName $nodename -NewNodeInterface $interface.name;\n} else {;\n  $hide = New-NlbCluster -ClusterName $nlbname -InterfaceName $($interface.name) -ClusterPrimaryIP $CLIP -SubnetMask $subnet -OperationMode \"Unicast\" -ea:0;\n};\nwrite-host \"Done\"","script_type":"npsscript","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"DomainCreds"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"9ef6a1b8_runbook","state":"ACTIVE","main_task_local_reference":{"kind":"app_task","name":"5baea253_dag"},"message_list":[],"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Install and Configure IIS"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[{"kind":"app_task","name":"Remove from Domain"},{"kind":"app_task","name":"Wait for reboot"}],"name":"15e4948c_dag","state":"ACTIVE","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Remove from Domain"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Wait for reboot"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"W2k12 IIS"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"Remove from Domain","state":"ACTIVE","attrs":{"exit_status":[],"script":"\n$DomainUsername = \"@@{DomainCreds.username}@@\"\n$DomainPassword = \"@@{DomainCreds.secret}@@\"\n$domainname @@{DomainFQDN}@@\"\n$Securepass = ConvertTo-SecureString -asPlainText -Force -String $DomainPassword\n$credential = New-Object System.Management.Automation.PSCredential(\"$($DomainName)\\$($DomainUsername)\",$Securepass)\nRemove-computer -UnjoinDomaincredential $credential -PassThru -Verbose -Force\nshutdown -r -t 30 -f","script_type":"npsscript","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"DomainCreds"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"W2k12 IIS"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"Wait for reboot","state":"ACTIVE","attrs":{"type":"","interval_secs":60},"timeout_secs":"0","type":"DELAY","variable_list":[]}],"description":"","name":"ff4b5aeb_runbook","state":"ACTIVE","main_task_local_reference":{"kind":"app_task","name":"15e4948c_dag"},"message_list":[],"variable_list":[]}},"variable_list":[]}],"app_profile_list":[{"deployment_create_list":[{"type":"GREENFIELD","action_list":[],"depends_on_list":[],"name":"475ef8f3_deployment","published_service_local_reference_list":[],"max_replicas":"8","package_local_reference_list":[{"kind":"app_package","name":"Install and Configure IIS"}],"substrate_local_reference":{"kind":"app_substrate","name":"IIS Application X"},"min_replicas":"1","variable_list":[],"description":""}],"description":"","action_list":[{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Get NLB"}],"name":"1a3a11d6_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"W2k12 IIS"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Get NLB","attrs":{"script":"Get-NlbCluster","type":"","command_line_args":"","exit_status":[],"script_type":"npsscript"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"6469d50c_runbook","main_task_local_reference":{"kind":"app_task","name":"1a3a11d6_dag"},"variable_list":[]},"name":"Report NLB"}],"name":"IIS","variable_list":[{"val_type":"STRING","description":"","name":"IIS_LB_IP","type":"LOCAL","value":"123","label":"","editables":{"value":true}},{"val_type":"STRING","description":"","name":"DomainFQDN","type":"LOCAL","value":"POC300.nutanix.local","label":"","attrs":{"type":""},"editables":{"value":true}},{"val_type":"STRING","description":"","name":"MachineName","type":"LOCAL","value":"IIS-@@{calm_time}@@","label":"","attrs":{"type":""},"editables":{"value":true}},{"val_type":"STRING","description":"","name":"IISAppName","type":"LOCAL","value":"PropellorApp","label":"","attrs":{"type":""},"editables":{"value":true}},{"val_type":"STRING","description":"","name":"IISwwwFQDN","type":"LOCAL","value":"www.propellorapp.eu","label":"","attrs":{"type":""},"editables":{"value":true}},{"val_type":"STRING","description":"","name":"NLBIP","type":"LOCAL","value":"10.64.96.39","label":"","attrs":{"type":""}}]}],"published_service_definition_list":[],"default_credential_local_reference":{"kind":"app_credential","name":"SysprepCreds"},"type":"USER"},"name":"IIS Customer Horizontal Scale"},"api_version":"3.0","metadata":{"last_update_time":"1550316282244565","kind":"blueprint","spec_version":98,"creation_time":"1549794280110918","name":"IIS Customer Horizontal Scale"}}